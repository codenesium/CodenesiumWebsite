<!DOCTYPE html>
<html>
  <head>
    <title>Codenesium Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.3" />
<title>Entity Framework :: Codenesium Documentation</title>
<link rel="shortcut icon" href="/documentation/images/favicon.png" type="image/x-icon" />
<link href="/documentation/css/font-awesome.min.css" rel="stylesheet">
<link href="/documentation/css/nucleus.css" rel="stylesheet">
<link href="/documentation/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/documentation/css/bootstrap.min.css">
<script src="/documentation/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "\/documentation";
</script>

<script>
var i=new Image();i.src="https://alb.reddit.com/t.gif?q=CAAHAAABAAoACQAAAAACbiNWAA==&s=kaLZRyF0BEqBfro3pLVnd01-R0k5I7C8ba0hXD7Tsbc=";
</script>
<noscript>
	<img height="1" width="1" style="display:none"
		 src="https://alb.reddit.com/t.gif?q=CAAHAAABAAoACQAAAAACbiNWAA==&s=kaLZRyF0BEqBfro3pLVnd01-R0k5I7C8ba0hXD7Tsbc=" />
</noscript>




<script async src="https://www.googletagmanager.com/gtag/js?id=AW-851792048"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-851792048');
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71359140-1', 'auto');
ga('send', 'pageview');

</script>

<style>
.nav-select
{
	margin-top:15px;
}
header:after
{
background:none;
}
header
{
  background-color: #2C3E50;
}

</style>

<link rel="shortcut icon" href="https://www.codenesium.com/img/favicon.png" type="image/x-icon" />



    
  </head>
  <body data-url="/documentation/codenesium/entityframework/">
    
      <header>
  <div class="logo">
    
	
  
    <p><img src="https://www.codenesium.com/img/favicon.png" alt="alt text" /> <a href="https://www.codenesium.com">Codenesium</a></p>

  

  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/documentation/" class="dd-item">
          <a href="/documentation/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/documentation/getting-started/" class="dd-item alwaysopen
        ">
      <div>
      <a href="/documentation/getting-started/">Getting started</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/documentation/codenesium/" class="dd-item parent alwaysopen haschildren
        ">
      <div>
      <a href="/documentation/codenesium/">Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/documentation/codenesium/appsettings/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/appsettings/">
            AppSettings
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/authentication/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/authentication/">
            Authentication
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/autofac/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/autofac/">
            Autofac
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/azure/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/azure/">
            Azure
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/controllers/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/controllers/">
            Controllers
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/databasemigrations/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/databasemigrations/">
            Database Migrations
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/deployment/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/deployment/">
            Deployment
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/docker/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/docker/">
            Docker
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/entityframework/" class="dd-item active">
        <div>
          <a href="/documentation/codenesium/entityframework/">
            Entity Framework
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/filters/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/filters/">
            Filters
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/healthchecks/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/healthchecks/">
            Health Checks
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/logging/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/logging/">
            Logging
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/performance/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/performance/">
            Performance
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
    <li data-nav-id="/documentation/codenesium/playground-server/" class="dd-item
        ">
      <div>
      <a href="/documentation/codenesium/playground-server/">Playground Server</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/documentation/codenesium/project-structure/" class="dd-item alwaysopen
        ">
      <div>
      <a href="/documentation/codenesium/project-structure/">Project Structure</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
      <li data-nav-id="/documentation/codenesium/repositories/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/repositories/">
            Repositories
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/windowsservice/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/windowsservice/">
            Running as Windows Service
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/services/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/services/">
            Services
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/swagger/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/swagger/">
            Swagger
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/testing/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/testing/">
            Testing
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/tooling/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/tooling/">
            Tooling
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/documentation/codenesium/validation/" class="dd-item">
        <div>
          <a href="/documentation/codenesium/validation/">
            Validation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/documentation/articles/" class="dd-item haschildren
        ">
      <div>
      <a href="/documentation/articles/">Articles</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/documentation/articles/entity-framework-example/" class="dd-item
        ">
      <div>
      <a href="/documentation/articles/entity-framework-example/">ASP.NET Core API with Entity Framework</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/documentation/articles/chaos-to-solid/" class="dd-item
        ">
      <div>
      <a href="/documentation/articles/chaos-to-solid/">Chaos to SOLID</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/documentation/account/" class="dd-item
        ">
      <div>
      <a href="/documentation/account/">Subscription</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/documentation/getting-started/" >
   Getting started</option> 
  
    <option value="/documentation/codenesium/" >
   Documentation</option> 
      <option value="/documentation/codenesium/appsettings/" >- AppSettings</option>
      <option value="/documentation/codenesium/authentication/" >- Authentication</option>
      <option value="/documentation/codenesium/autofac/" >- Autofac</option>
      <option value="/documentation/codenesium/azure/" >- Azure</option>
      <option value="/documentation/codenesium/controllers/" >- Controllers</option>
      <option value="/documentation/codenesium/databasemigrations/" >- Database Migrations</option>
      <option value="/documentation/codenesium/deployment/" >- Deployment</option>
      <option value="/documentation/codenesium/docker/" >- Docker</option>
      <option value="/documentation/codenesium/entityframework/"  selected>- Entity Framework</option>
      <option value="/documentation/codenesium/filters/" >- Filters</option>
      <option value="/documentation/codenesium/healthchecks/" >- Health Checks</option>
      <option value="/documentation/codenesium/logging/" >- Logging</option>
      <option value="/documentation/codenesium/performance/" >- Performance</option>
    <option value="/documentation/codenesium/playground-server/" >
  - 
   Playground Server</option>
    <option value="/documentation/codenesium/project-structure/" >
  - 
   Project Structure</option> 
  
      <option value="/documentation/codenesium/repositories/" >- Repositories</option>
      <option value="/documentation/codenesium/windowsservice/" >- Running as Windows Service</option>
      <option value="/documentation/codenesium/services/" >- Services</option>
      <option value="/documentation/codenesium/swagger/" >- Swagger</option>
      <option value="/documentation/codenesium/testing/" >- Testing</option>
      <option value="/documentation/codenesium/tooling/" >- Tooling</option>
      <option value="/documentation/codenesium/validation/" >- Validation</option>
  
    <option value="/documentation/articles/" >
   Articles</option>
    <option value="/documentation/account/" >
   Subscription</option>



        </select>
      </center>
    </div>
    

    <h1>Entity Framework</h1>
    
    
    
    

<h4 id="entities">Entities</h4>

<p>Every table in your database that you want to be exposed to Entity Framework needs a class for it.</p>

<p>AbstractEntityFrameworkPOCO is an empty abstract class that can be used to add fields to every table in the database like TenantId.</p>

<pre><code>namespace AdventureWorksNS.Api.DataAccess
{
    [Table(&quot;ContactType&quot;, Schema=&quot;Person&quot;)]
    public partial class ContactType: AbstractEntityFrameworkPOCO
    {
        public ContactType()
        {}

        public void SetProperties(
            int contactTypeID,
            DateTime modifiedDate,
            string name)
        {
            this.ContactTypeID = contactTypeID.ToInt();
            this.ModifiedDate = modifiedDate.ToDateTime();
            this.Name = name;
        }

        [Key]
        [Column(&quot;ContactTypeID&quot;)]
        public int ContactTypeID { get; set; }

        [Column(&quot;ModifiedDate&quot;)]
        public DateTime ModifiedDate { get; set; }

        [Column(&quot;Name&quot;)]
        public string Name { get; set; }
    }
}
</code></pre>

<h4 id="related-entities">Related Entities</h4>

<p>For performance reasons we don&rsquo;t load related entities.</p>

<p>You can add this by using .Include on the EF query.</p>

<pre><code>return this.Context.Set&lt;Customer&gt;().Where(predicate).AsQueryable().OrderBy(orderClause).Skip(skip).Take(take).ToList&lt;Customer&gt;();
</code></pre>

<p>Changes to</p>

<pre><code>return this.Context.Set&lt;Customer&gt;().Include(st =&gt; st.SalesTerritory.Name).Where(predicate).AsQueryable().OrderBy(orderClause).Skip(skip).Take(take).ToList&lt;Customer&gt;();
</code></pre>

<p>Then you have to modify your POCO and the object mapper to map this field to your POCO.</p>

<p>Related entities generates crazy SQL and I don&rsquo;t recommend using it.</p>

<h4 id="unit-of-work">Unit of Work</h4>

<p>Unit of work is accomplished by passing a transaction manager to all controllers and starting a transaction in the request pipeline and then rolling it back if there are errors or committing if there are none.</p>

<pre><code>public class EntityFrameworkTransactionCoordinator : ITransactionCoordinator
{
    private DbContext context;

    public EntityFrameworkTransactionCoordinator(DbContext context)
    {
        this.context = context;
    }

    public void BeginTransaction()
    {
        this.context.Database.BeginTransaction();
    }

    public void CommitTransaction()
    {
        if (this.context.Database.CurrentTransaction != null)
        {
            this.context.Database.CommitTransaction();
        }
    }

    public void DisableChangeTracking()
    {
        this.context.ChangeTracker.AutoDetectChangesEnabled = false;
    }

    public void EnableChangeTracking()
    {
        this.context.ChangeTracker.AutoDetectChangesEnabled = true;
    }

    public void RollbackTransaction()
    {
        if (this.context.Database.CurrentTransaction != null)
        {
            this.context.Database.RollbackTransaction();
        }
    }
}
</code></pre>

<p>Then in the filter that is applied to any methods you want unit of work applied to</p>

<pre><code>public class UnitOfWorkAttribute : ActionFilterAttribute
{
    public override void OnActionExecuting(ActionExecutingContext actionContext)
    {
        if(!(actionContext.Controller is AbstractApiController))
        {
            throw new Exception(&quot;UnitOfWorkActionFilter can only be applied to controllers that inherit from AbstractApiController&quot;);
        }

        AbstractApiController controller = (AbstractApiController)actionContext.Controller;
        controller.TransactionCooordinator.BeginTransaction();
        
    }

    public override void OnActionExecuted(ActionExecutedContext actionExecutedContext)
    {
        AbstractApiController controller = (AbstractApiController)actionExecutedContext.Controller;

        if (actionExecutedContext.Exception == null)
        {
            try
            {
                controller.TransactionCooordinator.CommitTransaction();
            }
            catch (DbUpdateConcurrencyException)
            {
                throw;
            }
            catch (Exception)
            {
                throw;
            }
        }
        else
        {
            try
            {
                controller.TransactionCooordinator.RollbackTransaction();
            }
            catch (Exception)
            {
                throw;
            }
        }

        base.OnActionExecuted(actionExecutedContext);
    }
}
</code></pre>

<h4 id="concurrency">Concurrency</h4>

<p>Concurrency is accomplished by applying an attribute to your Entity Framework POCO called ConcurrencyCheck. This attribute can be applied to multiple columns.</p>

<pre><code>[Column(&quot;ModifiedDate&quot;)]
[ConcurrencyCheck]
public DateTime ModifiedDate { get; set; }
</code></pre>

<p>Typically you would use a column called rowversion which is usually a timestamp column. When you retrieve data the column is sent along with the data to the client.
When the client makes an update the value is sent and if it has changed in the database since the retrieve then Entity Framework will throw a DbUpdateConcurrencyException exception. You can catch this exception in a filter and return something to the client to tell them to retry or to reload the data.</p>

<p>In the UnitOfWorkActionFilter we throw the exception by default. If you need retry functionality you will have to implement it</p>

<pre><code>public override void OnActionExecuted(ActionExecutedContext actionExecutedContext)
{
    AbstractApiController controller = (AbstractApiController)actionExecutedContext.Controller;

    if (actionExecutedContext.Exception == null)
    {
        try
        {
            controller.TransactionCooordinator.CommitTransaction();
        }
        catch (DbUpdateConcurrencyException)
        {
            throw;
        }
        catch (Exception)
        {
            throw;
        }
    }
</code></pre>

<h4 id="read-only-requests">Read only requests</h4>

<p>The ReadOnlyAttribute can be applied to any controller methods that only return data. This disables change tracking on the Entity Framework context which
drastically increases performance.</p>

<pre><code>public class ReadOnlyAttribute : ActionFilterAttribute
{
    public override void OnActionExecuting(ActionExecutingContext actionContext)
    {
        if(!(actionContext.Controller is AbstractApiController))
        {
            throw new Exception(&quot;ReadOnlyFilter can only be applied to controllers that inherit from AbstractApiController&quot;);
        }

        AbstractApiController controller = (AbstractApiController)actionContext.Controller;
        controller.TransactionCooordinator.DisableChangeTracking();
    }

    public override void OnActionExecuted(ActionExecutedContext actionExecutedContext)
    {
        base.OnActionExecuted(actionExecutedContext);
    }
}
</code></pre>

<h4 id="spatial-types">Spatial types</h4>

<p>We do not currently support spatial types. Entity Framework doesn&rsquo;t support them and we set them to do not generate. When support
is added to Entity Framework we will support them.</p>

<h4 id="primary-keys">Primary Keys</h4>

<p>We recommend unique, single field, integer primary keys. There is some contention on this issue but the reasons to design this way outweigh the negatives.</p>

<ol>
<li>Storage cost is lower because primary keys are stored in any indexes and foreign keys.</li>
<li>Joins with composite keys are nasty.</li>
<li>Auto increment is built in.</li>
<li>An integer is guaranteed unique. A natural key often starts off unique but this can cause problems later when you realize SSN isn&rsquo;t really unique.</li>
<li>To make sure your table really is a relation a composite unique index can accomplish your uniqueness. Changing this index later is cheap.
Changing a primary key after the fact stinks.</li>
<li>A single field primary key makes a lot of sense for a REST API. A composite key doesn&rsquo;t. Get(field1,field2,field3,field4)</li>
<li>They are developer friendly.</li>
<li>An alternative is a guid while using NEWSEQUENTIALID(). As a developer I hate dealing with guids in a database. If you need to be able to merge databases
later you can add a field to all of the tables called rowguid which is designed for this. Guids eat lots of disk space as primary keys.</li>
</ol>

<h4 id="performance-hints">Performance hints</h4>

<ol>
<li>Turn off change tracking for read-only requests.</li>
<li>Don&rsquo;t select more data than you need.</li>
<li>Beware using included columns.</li>
<li>Only return the columns you need. We don&rsquo;t do this by default and I think this is a premature optimization.</li>
<li>Keep the number of records in the context small by not reading a lot of records.</li>
</ol>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/documentation/codenesium/docker/" title="Docker"> <i class="fa fa-chevron-left"></i><label>Docker</label></a>
    <a class="nav nav-next" href="/documentation/codenesium/filters/" title="Filters" style="margin-right: 0px;"><label>Filters</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

  

    <div class="github-link">
      <a href="codenesium/entityFramework.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
  </div>


	<div>


  
    <p>See a mistake? Email us at support@codenesium.com</p>

  



	</div>
</footer>

<script src="/documentation/js/clipboard.min.js"></script>

<link href="/documentation/css/featherlight.min.css" rel="stylesheet">
<script src="/documentation/js/featherlight.min.js"></script>



<script src="/documentation/theme-flex/script.js"></script>

    

    
    

    
  </body>
</html>